<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AWARE IUI Workflow – Top Down</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: #ffffff;
            color: #111827;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: #ffffff;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        #graph-container {
            flex: 1;
            position: relative;
            background: #ffffff;
        }

        svg {
            width: 100%;
            height: 100%;
            background: #ffffff;
            cursor: grab;
        }

        .node circle {
            stroke: #1f2937;
            stroke-width: 1.4px;
        }

        .node text {
            font-size: 12px;
            pointer-events: none;
            fill: #111827;
        }

        .link {
            stroke: #9ca3af;
            stroke-width: 1.4px;
        }

        .link-arrow {
            fill: #9ca3af;
        }

        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="brand"><a href="/" style="text-decoration:none;color:inherit;">AWARE</a></div>

            <nav class="nav" aria-label="Main navigation">
                <a href="/">Home</a>
                <a href="/about">About</a>
                <a href="/flow" class="active">Flow</a>
            </nav>
        </div>

        <div class="right">
            <div class="user">Signed in as <strong>{{ user_id }}</strong></div>
            <div class="logout"><a href="/logout">Logout</a></div>
        </div>
    </div>
    <header>
        <h1>AWARE IUI Workflow (Top–Down Layout)</h1>
    </header>

    <div id="graph-container">
        <div id="tooltip" class="tooltip"></div>
        <svg id="graph"></svg>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script>

        /* -----------------------------
           NODES in Top–Down Order
        ------------------------------*/
        const nodes = [
            { id: "start", label: "Start", y: 60 },
            { id: "login", label: "Login / Create Account", y: 160 },
            { id: "welcome", label: "Welcome Screen", y: 260 },
            { id: "assessment", label: "Optional\nKnow Yourself", y: 360 },
            { id: "checkin", label: "Daily Check-In", y: 460 },
            { id: "engine", label: "Adaptive Engine", y: 560 },
            { id: "response", label: "Adaptive Response", y: 660 },
            { id: "mixed", label: "Mixed-Initiative Follow-Up", y: 760 },
            { id: "logging", label: "Log Interaction", y: 860 },
            { id: "patterns", label: "Optional Pattern Summary", y: 960 },
            { id: "end", label: "Closeout", y: 1060 }
        ];

        /* Horizontal position (centered) */
        nodes.forEach(n => n.x = 400);

        /* -----------------------------
           LINKS (vertical downward edges)
        ------------------------------*/
        const links = [
            { source: "start", target: "login", label: "User opens AWARE" },
            { source: "login", target: "welcome", label: "Authenticated" },
            { source: "welcome", target: "assessment", label: "Personalization option" },
            { source: "welcome", target: "checkin", label: "Skip assessment" },
            { source: "assessment", target: "checkin", label: "User model updated" },
            { source: "checkin", target: "engine", label: "Send input to engine" },
            { source: "engine", target: "response", label: "Rules + LLM" },
            { source: "response", target: "mixed", label: "Follow-up decision" },
            { source: "mixed", target: "logging", label: "End interaction" },
            { source: "logging", target: "patterns", label: "View patterns" },
            { source: "logging", target: "end", label: "Finish" },
            { source: "patterns", target: "end", label: "Close summary" }
        ];

        const colors = {
            start: "#38bdf8",
            login: "#38bdf8",
            welcome: "#38bdf8",
            assessment: "#f97316",
            checkin: "#38bdf8",
            engine: "#22c55e",
            response: "#22c55e",
            mixed: "#22c55e",
            logging: "#a855f7",
            patterns: "#f97316",
            end: "#facc15"
        };

        const svg = d3.select("#graph");
        const width = 900;
        const height = 1300;

        svg.attr("viewBox", [0, 0, width, height]);

        /* Arrowhead */
        const defs = svg.append("defs");
        defs.append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 18)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "#9ca3af");

        /* Tooltip */
        const tooltip = d3.select("#tooltip");

        /* Draw links */
        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("x1", d => nodes.find(n => n.id === d.source).x)
            .attr("y1", d => nodes.find(n => n.id === d.source).y)
            .attr("x2", d => nodes.find(n => n.id === d.target).x)
            .attr("y2", d => nodes.find(n => n.id === d.target).y)
            .attr("class", "link")
            .attr("marker-end", "url(#arrow)")
            .on("mouseover", function (event, d) {
                tooltip
                    .style("opacity", 1)
                    .html(`<strong>${d.source} → ${d.target}</strong><br>${d.label}`);
            })
            .on("mousemove", function (event) {
                tooltip
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY + 10) + "px");
            })
            .on("mouseout", function () { tooltip.style("opacity", 0); });

        /* Draw nodes */
        const node = svg.append("g")
            .selectAll("g")
            .data(nodes)
            .enter()
            .append("g")
            .attr("transform", d => `translate(${d.x}, ${d.y})`);

        node.append("circle")
            .attr("r", 28)
            .attr("fill", d => colors[d.id] || "#6b7280");

        node.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "0.35em")
            .selectAll("tspan")
            .data(d => d.label.split("\n"))
            .enter()
            .append("tspan")
            .attr("x", 0)
            .attr("dy", (d, i) => i ? "1.2em" : "0")
            .text(d => d);

    </script>
</body>

</html>